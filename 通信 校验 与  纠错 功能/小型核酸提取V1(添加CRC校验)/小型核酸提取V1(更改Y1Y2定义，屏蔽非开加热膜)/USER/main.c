

#include "sys.h"
#include "delay.h"
#include "usart.h"
#include "exti.h"
#include "timer.h"
#include "spi.h"
#include "pwm.h"
#include "moto.h"
#include "string.h"
#include "DeviceVibration.h"
#include "adc.h"
#include "128S085.h"
#include "adc.h"
//ÐèÒªÍêÉÆµÄ¹¦ÄÜ£»
//²âÊÔ·Ç±êÄ£Ê½
//ÎÂ¶ÈÐ£×¼
//ÎÂ¶È³¬ÎÂ±¨¾¯
//Õñµ´Ê±Ã»ÓÐ¼ÆÊ±Ê±¼ä£¬£¬Ë¼Â·²ÉÓÃTime5¶¨Ê±Æ÷£»
//²âÊÔ½ÓÊÕÖ¸ÁîÖ´ÐÐ, ´ò¿ª½ÓÊÕÎÂ¶ÈÖµÃüÁî  ¼ÌµçÆ÷×´Ì¬Ö¸Áî   ¼ÓÈÈÖ¸Áî   ÔÚ´®¿ÚÃüÁî´¦Àíº¯ÊýÖÐÌí¼ÓFrameCopyDeal 
//ÊµÏÖÔÝÍ£Ö¸Áî£¬Ë¼Â· Í¨¹ý¿ª¹ØPWMµÄ¶¨Ê±Æ÷ Timer1 Timer3 Timer8£»
//

//adc ²ÉÑù»á²»»áÓ°Ïìµ½Õðµ´ÊµÑé£»adc ²ÉÑùÊ±¼ä¼Ó³¤£»
//¼Ó¼õËÙµÄ²¿Êð²âÊÔ£»
//
#define FB_POS 1600

#define temp_hot 1
#define temp_cool 0

#define Y1_up 1
#define Y1_down 0
#define Y2_up 1
#define Y2_down 0
#define Y2Y1_up 1
#define Y2Y1_down 0
#define X_forward 1
#define X_backward  0

u8 Flag_run = 0;               //¼ÇÂ¼ÒÇÆ÷ÔËÐÐ×´Ì¬£¬0£ºÍ£Ö¹£»1£ºÔÝÍ££»2£º¸´Î»½áÊø£»3,9£º×¼±¸¾ÍÐ÷£¨½ÓÊÕµ½Æô¶¯Ö¸Áî£¬ÇÒ¸´Î»½áÊø£©£»4£ºÔËÐÐ×´Ì¬
u8 read = 0;
char SendBackBuff[20]={0};
u16 fun_tim;

//

//u16 temp_to_vol[8][90]={
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191},
//												
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191},
//												
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191},
//												
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191},
//												
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191},
//												
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191},
//												
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191},
//												
//												{2070,2048,2026,2004,1982,1960,1940,1920,1900,1880,1859,1839,1821,1802,1785,1767,1745,1733,1716,1699,1683,
//												1663,1647,1632,1618,1603,1590,1577,1564,1551,1539,1526,1513,1503,1491,1481,1469,1459,1449,1440,1431,1422,
//												1410,	1402,1394,1386,1372,1364,1357,1349,1341,1335,1327,1321,1315,1310,1305,1299,1294,1290,1284,1276,1269,
//												1263,1259,1255,1252,1247,1244,1242,1238,1234,1230,1225,1222,1219,1217,  1215,1213,1211,1209,1207,1205,1203,
//												1201,1199,1197,1195,1193,1191}
//												};
//u16 vol_to_temp[8][90]={
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347},
//												
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347},
//												
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347},
//												
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347},
//												
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347},
//												
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347},
//												
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347},
//												
//												{2186,2137,2093,2046,1999,1954,1907,1858,1809,1758,1712,1668,1628,1590,1549,1513,1479,1444,1412,1377,1342,
//												1310,1278,1245,1214,1182,1148,1120,1092,1063,1035,1008,981,955,931,906,882,865,845,827,805,782,760,737,715,
//												694,675,658,642,625,609,593,577,559,545,531,517,504,492,479,464,453,442,431,420,409,398,388,377,367,357,347}											
//											};

											
											
		//²âÊÔ´ÉÌ×ÏÂ½µ¹¦ÄÜ¡£¡£¡£									
											

int main(void)
{ 	
	u16 i;	
	
	u16 vbottom;
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);//ÉèÖÃÏµÍ³ÖÐ¶ÏÓÅÏÈ¼¶·Ö×é2
	EXTIX_Init();
	delay_init(168);                               //³õÊ¼»¯ÑÓÊ±º¯Êý              
	uart_init(9600);	                           //³õÊ¼»¯´®¿Ú²¨ÌØÂÊÎª115200	
//	Package("dialogbox","8",SendBackBuff);
//	Send_Str(SendBackBuff);	

//	delay_ms(100);      //ÑÓÊ±	
	InitSwitch();  //control switch to hot     //@lyt,GPIOD,GPIOE,³õÊ¼»¯	
	
	TIM1_GPIO_Config();          //168M Âö³å		
	TIM1_PWM_Init(4000-1,42-1); //2M/4000 =500HZ   500  6000  1.25mm/s  6M   1KHZ   600 75ms/s        2ms //  ²ÉÓÃ4M Ö÷ÆµÉèÖÃ	
	TIM3_PWM_Init(4000-1,42-1);   // 2M  Y1µç»úPWM³õÊ¼»¯	
	TIM8_PWM_Init(4000-1,84-1);   // 2M   Y2µç»úPWM³õÊ¼»¯	
	

//	
	delay_ms(2000);

//	X_EN =1;
//	YT_EN =1;
//	YB_EN =1;
	
	delay_ms(500);

	X_EN =0;
	YT_EN =0;
	YB_EN =0;
	
	delay_ms(500);
	YT_EN =1;
	X_EN =1;
	YB_EN =1;
	
	delay_ms(500);


	
	Y1Y2Reset();      //YÖá¸´Î»	
	X0Reset();  //µÈ´ýYÖá¸´Î»½áÊø£¬ºó£¬XÖá¸´Î»  
//	while(1)
//		Send_Str(":h=1\r\n");
	 Dac128S_Init();   //Íâ²¿DAC³õÊ¼»¯  V
	
  bsp_InitADC();   
  
  TIM5_Int_Init(4999-1,8400-1);//40ms ²É¼¯ÖÜÆÚ£¬32´Î ½øÐÐÆ½¾ùÔËËãÒ»´Î£   1s
	TIM_Cmd(TIM5,ENABLE);
	
	
	
	
	Tim2Config();	
	TIM_Cmd(TIM2, ENABLE);  

 //printf("hello,world");
  
  while(1)
	{		
//		MotorX0Mov(1,800,10000); 
//		delay_ms(4000);
//		MotorX0Mov(0,800,10000); ²âÊÔ
		

		
      FrameCopyDeal();  //´®¿ÚÍ¨ÐÅ´¦Àíº¯Êý£¬½ÓÊÕ´¥ÃþÆÁµÄÖ¸Áî£»
/*************************************ÕÕÃ÷µÆ**************************************/
			if(lll==1)			   //ÅÐ¶ÏÊÇ·ñ¿ªµÆ
			{			 	
				lll = 2;
				BAK = 1;	//ligth IO kou
			}
			else if(lll==3)
			{			 	
				lll = 2;
				BAK = 0;			 
			}
			
	/***********************************»»´ÅÌ×ÏÂ½µ************************************/
			if(lll==5)
			{
				lll = 2;  
				MotorX0Mov(X_forward,800,xdelt);  /////xdelt ==0;
				MotorY1Mov(Y1_down,600,2000);   //1500
			}	 
				
	/***********************************¸´Î»/»»´ÅÌ×ÉÏÉý********************************/
			if(lll==7)
			{
				lll=2;		 
				MotorY2Mov(Y2_down,200,100);		
				Y1Y2Reset();	
        				
			}	
	
	/************************************¼ÓÈÈÄ£¿é,¿ªÆô/¹Ø±Õ£¬ÉèÖÃÎÂ¶È********************/
//							  
//					  
//					
//					  Dac128S085_Vol(GetVoltageDACS(BDDac[3],3),3);
//					  Dac128S085_Vol(GetVoltageDACS(BDDac[4],4),4);
//					  Dac128S085_Vol(GetVoltageDACS(BDDac[5],5),5);
//					  Dac128S085_Vol(GetVoltageDACS(BDDac[6],6),6);
//					  Dac128S085_Vol(GetVoltageDACS(BDDac[7],7),7); 



//			Dac128S085_Vol(GetVoltageDACS(BDDac[0],0),0);
//	//		Dac128S085_Vol(1200,0);  // Í¨µÀÎÂ¶ÈµÄÉèÖÃ 1200 -60¶È£»
//			delay_ms(1);
//			Switch0=!w0r;
//			
//			
//			Dac128S085_Vol(GetVoltageDACS(BDDac[1],1),1);
//		//	Dac128S085_Vol(1200,1);  	
//			delay_ms(1);
//			Switch1=!w1r;
//			
//			
//			Dac128S085_Vol(GetVoltageDACS(BDDac[2],2),2);
//	//		Dac128S085_Vol(1200,2);  
//			delay_ms(1);
//			Switch2=!w2r;
//			
//			
//			Dac128S085_Vol(GetVoltageDACS(BDDac[3],3),3);
//	//		Dac128S085_Vol(1200,3); 
//			delay_ms(1);
//			Switch3=!w3r;
//		
//			
//			Dac128S085_Vol(GetVoltageDACS(BDDac[4],4),4);
//		//	Dac128S085_Vol(1200,4); 
//			delay_ms(1);
//			Switch4=!w4r;
//			
//     Dac128S085_Vol(GetVoltageDACS(BDDac[5],5),5);
//		//	Dac128S085_Vol(1200,5); 
//			delay_ms(1);
//			Switch5=!w5r;
//			
//			
//			Dac128S085_Vol(GetVoltageDACS(BDDac[6],6),6);
//		//	Dac128S085_Vol(1200,6); 
//			delay_ms(1);
//			Switch6=!w6r;
//			
//			
//			Dac128S085_Vol(GetVoltageDACS(BDDac[7],7),7); 
//	//		Dac128S085_Vol(1200,7);  
//			delay_ms(1);
//			Switch7=!w7r;
			
			
			
	/************************************·çÉÈ¿ØÖÆ**************************************/
			if(lll==16)
			{
					lll=2;
					FUN = 1;
			}
			else if(lll==17)
			{
					lll=2;
					FUN = 0;
			}
	/*****************************µç¼ÓÈÈÄ¤¿ØÖÆ*********************************************/
			switch(lll)
			{
				case 8 :
					Switch0=1;					
					break;
				case 9 :
					Switch0=0;					
					break;
				case 10 :
					Switch1=1;					
					break;
				case 11 :
					Switch1=0;					
					break;
				case 12 :
					Switch2=1;					
					break;
				case 13 :
					Switch2=0;					
					break;
				case 14 :
					Switch3=1;					
					break;
				case 15 :
					Switch3=0;					
					break;
				case 18 :
					Switch4=1;					
					break;
				case 19 :
					Switch4=0;					
					break;
				case 20 :
					Switch5=1;					
					break;
				case 21 :
					Switch5=0;					
					break;
				case 22 :
					Switch6=1;					
					break;
				case 23 :
					Switch6=0;					
					break;
				case 24:
					Switch7=1;					
					break;
				case 25 :
					Switch7=0;					
					break;
        default :
//					Send_Str_uart4(": unknow  lll command");
				  break;
          					
			}
						
	/*****************************************×ÏÍâµÆ****************************************/
			if(uuu==1)		//ÅÐ¶ÁÊÇ·ñÏû¶¾
			{
					UV=1;
			}
			else if((uuu==0)||(uuu==3))
			{
					UV=0;
			}
				
	/************************************µç»úÔËÐÐ³ÌÐò****************************************/
			if((sss == 3 )	&& (ReadP == WriteP))		  //¼à²âµ½¿ªÊ¼ÐÅºÅ£¬²¢ÇÒ¶ÁÈ¡ÁËËùÓÐµÄÊäÈëÁ¿
			{		
				if(DOOR == 1) 
				{
						sss = 0;
					  Flag_run = 2;
//						Send_Str(":dialogbox=8!\r\n");	
            Package("dialogbox","8",SendBackBuff);
						Send_Str(SendBackBuff);					
					  memset(USART_RX_BUF,0,USART_REC_LEN);
					  ReadP = 0;
					  WriteP = 0;
					  delay_ms(100);				
				}
				else
				{					
//					Send_Str_uart4(" biaocheng_run\r\n");
					Flag_run = 4;                                    //±êÊ¶ÒÇÆ÷ÕýÔÚÔËÐÐ
					Y1RSTOV = 0;
					Y2RSTOV = 0;
					X0RSTOV = 0;		
		
					
//					memset(USART_RX_BUF,0,USART_REC_LEN);
//					ReadP = 0;
//					WriteP = 0;
					MovProcess();  
				}			
				
			}       	  
				
			
	/******************************************×ÔÓÉ±à³Ì************************************/
	//·Ç±êÄ£Ê½
	    if((sss == 9)  && (ReadP == WriteP))
			{						
				  if(DOOR == 1)
					{
					  sss=0;
						Flag_run=2;
//						Send_Str("dialogbox=8!\r\n");
						Package("dialogbox","8",SendBackBuff);
						Send_Str(SendBackBuff);
						memset(USART_RX_BUF,0,USART_REC_LEN);						
						ReadP = 0;
					  WriteP = 0;	
					}
					else
					{
						  if(Flag_run == 9)							   //Èç¹û¸´Î»½áÊø£¬ÇÒÒÇÆ÷»¹Î´Æô¶¯£¬ÔòÉèÖÃXÖáÆ«ÒÆ
							{
								 FUN  =1;
								//	BAK  =1;
									Switch0=!w0r;
									Switch1=!w1r;
									Switch2=!w2r;
									Switch3=!w3r;
									Switch4=!w4r;
									Switch5=!w5r;
									Switch6=!w6r;
									Switch7=!w7r;	
									if(t0k&&t1k&&t2k&&t3k&&t4k&&t5k&&t6k&&t7k)
									{
										Dac128S085_Vol(GetVoltageDACS(t0k,7),7);		
										Dac128S085_Vol(GetVoltageDACS(t1k,5),5);	
										Dac128S085_Vol(GetVoltageDACS(t2k,3),3);//		Dac128S085_Vol(1200,2);  
										Dac128S085_Vol(GetVoltageDACS(t3k,1),1);		
										Dac128S085_Vol(GetVoltageDACS(t4k,4),4);//	Dac128S085_Vol(1200,4); 		
										Dac128S085_Vol(GetVoltageDACS(t5k,6),6);//	Dac128S085_Vol(1200,5); 		
										Dac128S085_Vol(GetVoltageDACS(t6k,0),0);		
										Dac128S085_Vol(GetVoltageDACS(t7k,2),2); 									
										delay_ms(1000);										
									
										if(w0r == 1)
										{
										while(ad[7]+2 < t0k);
										}
										if(w1r == 1)
										{
										while(ad[4]+2 < t4k);
										}
										if(w2r == 1)
										{
										while(ad[5]+2 < t1k);
										}

										if(w3r == 1)
										{
										while(ad[6]+2 < t5k);
										}

										if(w4r == 1)
										{
										while(ad[3]+2 < t2k);
										}

										if(w5r == 1)
										{
										while(ad[0]+2 < t6k);
										}
										if(w6r == 1)
										{
										while(ad[1]+2 < t3k);
										}
										if(w7r == 1)
										{
										while(ad[2]+2 < t7k);
										}
									}
									else
									{	
										//err;
									}	
								
								
								
								
								 MotorX0Mov(X_forward,600,xdelt);		
//								 MotorY1Mov(Y1_down,800,y1firstmov-FB_POS);
//								 MotorY2Mov(Y2_down,800,y1frstmov-FB_POS); 	 
							 	MotorY1Mov(Y1_down,800,y1firstmov);
								MotorY2Mov(Y2_down,800,y2firstmov); 
									
//							   Send_Str_uart4(": feibiao\r\n");							
							}
													
							Flag_run = 4;
//							EXTI->IMR|=1<<2;	   //´ò¿ªÖÐ¶Ï£¬³ÌÐòÈÝÒ×ÅÜ·É
//							EXTI->IMR|=1<<3;
//							EXTI->IMR|=1<<4;
							
//							memset(USART_RX_BUF,0,USART_REC_LEN);
//							ReadP = 0;
//							WriteP = 0;
//							
				/************************Õñ¶¯»ìÔÈ**********************/		
							if(s0p==1)
							{
								s0p=0;
								if(s3p<0)
								{
									MotorX0Mov(X_backward,600,7200*abs(s3p));
								}
								else
								{
									MotorX0Mov(X_forward,600,7200*abs(s3p));
								}
								//	u16 Vibbottom0= (u16)vibbottom0*39.3;
								
								
								MotorY1Mov(Y1_down,800,FB_POS);
								vbottom=(vibbottom0)*39.3;
								vibbottom0=0;
								
						  	MotorY1Mov(Y1_up,800,vbottom);
								
////    						MotoY1Mov(Y1_up,800,((vibbottom0+vibbottom1+vibbottom2+vibbottom3+vibbottom4+vibbottom5+vibbottom6+vibbottom7)/(2.034*20))*1600);
//								vibbottom0=0;
//								vibbottom1=0;
//								vibbottom2=0;
//								vibbottom3=0;
//								vibbottom4=0;
//								vibbottom5=0;
//								vibbottom6=0;
//								vibbottom7=0;
								
								MotorY1Vib(s1p,s2p,s5p*60);	
								
								MotorY1Mov(Y1_up,800,FB_POS-vbottom);
								
								Package("overflag","1",SendBackBuff);
//								Send_Str_uart4(": zhengdang11\r\n");
								Send_Str(SendBackBuff);
//								Send_Str_uart4(": zhengdang\r\n");
							}
							
					/************************µÈ´ýÊ±¼ä**********************/						
							if(s0p==2)
							{
								s0p=0;
								if(s3p<0)
								{
									MotorX0Mov(X_backward,600,7200*abs(s3p));
								}
								else
								{
									MotorX0Mov(X_forward,600,7200*abs(s3p));
								}
								delay_ms(s5p*60*1000);			
								Package("overflag","1",SendBackBuff);
								Send_Str(SendBackBuff);
//								Send_Str_uart4(": dengdai\r\n");
							}
							
					/************************Îü´ÅÖé**********************/						
							if(s0p==3)
							{
								s0p=0;
								if(s3p<0)
								{
									MotorX0Mov(X_backward,600,7200*abs(s3p));
								}
								else
								{
									MotorX0Mov(X_forward,600,7200*abs(s3p));
								}			
								
								MotorY1Y2Mov(Y2Y1_down,s4p,FB_POS);
								delay_ms(5);
								MotorY1Y2Mov(Y2Y1_up,s4p,FB_POS);
								Package("overflag","1",SendBackBuff);
								Send_Str(SendBackBuff);
//								Send_Str_uart4(": xi\r\n");
							}
							
					/************************·Å´ÅÖé**********************/					
							if(s0p==4)
							{
								s0p=0;
								if(s3p<0)
								{
									MotorX0Mov(X_backward,600,7200*abs(s3p));
								}
								else
								{
									MotorX0Mov(X_forward,600,7200*abs(s3p));
								}
								
								
								MotorY1Y2Mov(Y2Y1_down,s4p,FB_POS-250);
								MotorY2Mov(Y2_up,800,FB_POS-250);
								MotorY1Mov(Y1_up,800,FB_POS-250);
								Package("overflag","1",SendBackBuff);
								Send_Str(SendBackBuff);
//								Send_Str_uart4(": fang\r\n");
							}
							
					/************************Á÷³Ì½áÊø**********************/			
							if(usy==1)
							{
								usy=0;
//								Y1Y2Reset();
//								X0Reset();	
//								for(i=30000;i>0;i--);      //ÑÓÊ±	
//								delay_ms(1000);
								Switch0 =1;
								Switch1 =1;
								Switch2 =1;
								Switch3 =1;
								Switch4 =1;
								Switch5 =1;
								Switch6 =1;
								Switch7 =1;	  //¹Ø±Õ¼ÌµçÆ÷¼ÓÈÈÍÐÅÌ	
								
								Package("overflag","2",SendBackBuff);
								Send_Str(SendBackBuff);
//								Send_Str_uart4(": end\r\n");
								fun_tim=0;
								while(fun_tim<100);		
//                delay_ms(3000);								
								FUN  =0;	
								OverAlarm();								
								Flag_run=0;
								
								__set_FAULTMASK(1);
								NVIC_SystemReset();
//								Send_Str_uart4(": end2\r\n");
							}
					}
			}
	
				     
  	} 	 	 
 }
		
 
	




